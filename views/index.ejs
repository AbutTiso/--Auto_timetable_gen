<script>
    // Navigation between sections
    document.getElementById('home-link').addEventListener('click', function() {
        document.getElementById('home-section').style.display = 'block';
        document.getElementById('timetable-section').style.display = 'none';
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        this.classList.add('active');
    });

    document.getElementById('timetable-link').addEventListener('click', function() {
        document.getElementById('home-section').style.display = 'none';
        document.getElementById('timetable-section').style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        this.classList.add('active');
    });

    // Initialize with home active
    document.getElementById('home-link').classList.add('active');

    // Timetable generation with AJAX
    document.getElementById('generate-timetable-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const button = this.querySelector('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        button.disabled = true;

        fetch('/generate-timetable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to generate timetable');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    });

    // Edit modal functionality
    let currentDay = '';
    let currentPeriod = '';
    let currentTeacher = '';

    // Function to open edit modal
    window.openEditModal = function(day, period, teacher) {
        currentDay = day;
        currentPeriod = period;
        currentTeacher = teacher;
        
        // Update modal title
        const modalTitle = document.querySelector('.modal-title');
        modalTitle.innerHTML = `<i class="fas fa-edit"></i> Edit ${day} - Period ${period}`;
        
        // Update current teacher display
        const currentTeacherDisplay = document.getElementById('current-subjects-with-category');
        if (teacher && teacher !== 'EMPTY' && teacher !== null) {
            currentTeacherDisplay.textContent = teacher;
        } else {
            currentTeacherDisplay.textContent = 'Empty slot';
        }
        
        // Populate dropdown with deleted lessons
        populateDeletedLessonsDropdown(teacher);
        
        // Show modal
        $('#editModal').modal('show');
    };

    // Function to populate dropdown with deleted lessons
    function populateDeletedLessonsDropdown(currentTeacherName) {
        const select = document.getElementById('subject-select');
        select.innerHTML = '';
        
        // Add empty slot option
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '-- Empty slot (no lesson) --';
        emptyOption.className = 'text-muted';
        if (!currentTeacherName || currentTeacherName === 'EMPTY' || currentTeacherName === null) {
            emptyOption.selected = true;
        }
        select.appendChild(emptyOption);
        
        // Get deleted lessons from server
        fetch('/get-deleted-lessons')
            .then(response => response.json())
            .then(data => {
                const deletedLessons = data.deletedLessons || [];
                
                // Add deleted lessons
                if (deletedLessons.length > 0) {
                    deletedLessons.forEach(lesson => {
                        if (lesson.teacher) {
                            const option = document.createElement('option');
                            option.value = lesson.teacher;
                            option.textContent = `↩️ ${lesson.teacher} (recently deleted)`;
                            option.classList.add('text-info');
                            select.appendChild(option);
                        }
                    });
                } else {
                    // If no deleted lessons
                    const noDeletedOption = document.createElement('option');
                    noDeletedOption.value = '';
                    noDeletedOption.textContent = 'No deleted lessons available';
                    noDeletedOption.disabled = true;
                    noDeletedOption.classList.add('text-muted', 'font-italic');
                    select.appendChild(noDeletedOption);
                }
                
                // Select current teacher if exists
                if (currentTeacherName && currentTeacherName !== 'EMPTY' && currentTeacherName !== null) {
                    select.value = currentTeacherName;
                }
            })
            .catch(error => {
                console.error('Error fetching deleted lessons:', error);
                select.innerHTML = '<option disabled class="text-muted">Error loading deleted lessons</option>';
            });
    }

    // Save changes button handler
    document.getElementById('save-changes').addEventListener('click', function() {
        const selectedTeacher = document.getElementById('subject-select').value;
        
        // Send update to server
        updateTimetableSlot(currentDay, currentPeriod, selectedTeacher);
    });

    // Function to update timetable slot
    function updateTimetableSlot(day, period, teacher) {
        const button = document.getElementById('save-changes');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        button.disabled = true;

        // Use the delete-slot endpoint if empty, otherwise use save-timetable
        if (!teacher || teacher === '') {
            // Delete slot
            fetch('/delete-slot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    day: day,
                    slot: period
                })
            })
            .then(response => response.json())
            .then(data => {
                $('#editModal').modal('hide');
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                const errorMessage = document.getElementById('modal-error-message');
                errorMessage.textContent = 'Failed to update slot';
                errorMessage.style.display = 'block';
                button.innerHTML = originalText;
                button.disabled = false;
            });
        } else {
            // Save timetable with updated slot
            fetch('/get-timetable')
            .then(response => response.json())
            .then(data => {
                const timetable = data.timetable || {};
                
                // Update the specific slot
                if (!timetable[day]) timetable[day] = [];
                timetable[day][period] = teacher;
                
                // Send updated timetable to server
                return fetch('/save-timetable', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ timetable: timetable })
                });
            })
            .then(response => response.json())
            .then(data => {
                $('#editModal').modal('hide');
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                const errorMessage = document.getElementById('modal-error-message');
                errorMessage.textContent = 'Failed to update slot';
                errorMessage.style.display = 'block';
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
    }

    // Clear error message when modal is hidden
    $('#editModal').on('hidden.bs.modal', function() {
        document.getElementById('modal-error-message').style.display = 'none';
    });
</script>