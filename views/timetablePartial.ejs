<div class="table-responsive">
    <table id="timetable" class="table table-bordered table-hover">
        <thead class="thead-dark">
            <tr>
                <th style="width: 120px;">Time</th>
                <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { %>
                    <th data-day="<%= day %>" class="text-center"><%= day %></th>
                <% }); %>
            </tr>
        </thead>

        <tbody>
            <!-- Lesson 1 (Slot 0) -->
            <tr data-slot="0">
                <td class="font-weight-bold">
                    <div>8:00 - 9:00</div>
                    <small class="text-muted">Lesson 1</small>
                </td>
                <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { %>
                    <% const teacher = data.timetable && data.timetable[day] && data.timetable[day][0]; %>
                    <td data-day="<%= day %>" class="slot-cell">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="subjects flex-grow-1">
                                <% if (teacher) { %>
                                    <div class="teacher-display">
                                        <% if (teacher.includes('Languages')) { %>
                                            <span class="badge badge-languages teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sciences')) { %>
                                            <span class="badge badge-sciences teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Arts')) { %>
                                            <span class="badge badge-arts teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sports')) { %>
                                            <span class="badge badge-sports teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else { %>
                                            <span class="badge badge-secondary teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } %>
                                    </div>
                                <% } else { %>
                                    <span class="text-muted">-</span>
                                <% } %>
                            </span>
                            <div class="btn-group btn-group-sm ml-2">
                                <button class="btn btn-outline-primary edit-btn" data-toggle="modal" data-target="#editModal" 
                                        title="Edit lesson">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger delete-btn" title="Clear lesson">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </td>
                <% }); %>
            </tr>

            <!-- Lesson 2 (Slot 1) -->
            <tr data-slot="1">
                <td class="font-weight-bold">
                    <div>9:00 - 10:00</div>
                    <small class="text-muted">Lesson 2</small>
                </td>
                <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { %>
                    <% const teacher = data.timetable && data.timetable[day] && data.timetable[day][1]; %>
                    <td data-day="<%= day %>" class="slot-cell">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="subjects flex-grow-1">
                                <% if (teacher) { %>
                                    <div class="teacher-display">
                                        <% if (teacher.includes('Languages')) { %>
                                            <span class="badge badge-languages teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sciences')) { %>
                                            <span class="badge badge-sciences teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Arts')) { %>
                                            <span class="badge badge-arts teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sports')) { %>
                                            <span class="badge badge-sports teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else { %>
                                            <span class="badge badge-secondary teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } %>
                                    </div>
                                <% } else { %>
                                    <span class="text-muted">-</span>
                                <% } %>
                            </span>
                            <div class="btn-group btn-group-sm ml-2">
                                <button class="btn btn-outline-primary edit-btn" data-toggle="modal" data-target="#editModal" 
                                        title="Edit lesson">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger delete-btn" title="Clear lesson">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </td>
                <% }); %>
            </tr>

            <!-- Lesson 3 (Slot 2) -->
            <tr data-slot="2">
                <td class="font-weight-bold">
                    <div>10:00 - 11:00</div>
                    <small class="text-muted">Lesson 3</small>
                </td>
                <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { %>
                    <% const teacher = data.timetable && data.timetable[day] && data.timetable[day][2]; %>
                    <td data-day="<%= day %>" class="slot-cell">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="subjects flex-grow-1">
                                <% if (teacher) { %>
                                    <div class="teacher-display">
                                        <% if (teacher.includes('Languages')) { %>
                                            <span class="badge badge-languages teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sciences')) { %>
                                            <span class="badge badge-sciences teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Arts')) { %>
                                            <span class="badge badge-arts teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sports')) { %>
                                            <span class="badge badge-sports teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else { %>
                                            <span class="badge badge-secondary teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } %>
                                    </div>
                                <% } else { %>
                                    <span class="text-muted">-</span>
                                <% } %>
                            </span>
                            <div class="btn-group btn-group-sm ml-2">
                                <button class="btn btn-outline-primary edit-btn" data-toggle="modal" data-target="#editModal" 
                                        title="Edit lesson">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger delete-btn" title="Clear lesson">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </td>
                <% }); %>
            </tr>

            <!-- Morning Break (No Slot) -->
            <tr class="table-info">
                <td class="font-weight-bold text-center">
                    <div>11:00 - 11:25</div>
                    <small class="text-muted">Morning Break</small>
                </td>
                <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { %>
                    <td class="text-center text-muted">
                        <i class="fas fa-coffee"></i> Break
                    </td>
                <% }); %>
            </tr>

            <!-- Lesson 4 (Slot 3) -->
            <tr data-slot="3">
                <td class="font-weight-bold">
                    <div>11:25 - 12:25</div>
                    <small class="text-muted">Lesson 4</small>
                </td>
                <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { %>
                    <% const teacher = data.timetable && data.timetable[day] && data.timetable[day][3]; %>
                    <td data-day="<%= day %>" class="slot-cell">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="subjects flex-grow-1">
                                <% if (teacher) { %>
                                    <div class="teacher-display">
                                        <% if (teacher.includes('Languages')) { %>
                                            <span class="badge badge-languages teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sciences')) { %>
                                            <span class="badge badge-sciences teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Arts')) { %>
                                            <span class="badge badge-arts teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sports')) { %>
                                            <span class="badge badge-sports teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else { %>
                                            <span class="badge badge-secondary teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } %>
                                    </div>
                                <% } else { %>
                                    <span class="text-muted">-</span>
                                <% } %>
                            </span>
                            <div class="btn-group btn-group-sm ml-2">
                                <button class="btn btn-outline-primary edit-btn" data-toggle="modal" data-target="#editModal" 
                                        title="Edit lesson">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger delete-btn" title="Clear lesson">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </td>
                <% }); %>
            </tr>

            <!-- Lesson 5 (Slot 4) -->
            <tr data-slot="4">
                <td class="font-weight-bold">
                    <div>12:25 - 13:25</div>
                    <small class="text-muted">Lesson 5</small>
                </td>
                <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { %>
                    <% const teacher = data.timetable && data.timetable[day] && data.timetable[day][4]; %>
                    <td data-day="<%= day %>" class="slot-cell">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="subjects flex-grow-1">
                                <% if (teacher) { %>
                                    <div class="teacher-display">
                                        <% if (teacher.includes('Languages')) { %>
                                            <span class="badge badge-languages teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sciences')) { %>
                                            <span class="badge badge-sciences teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Arts')) { %>
                                            <span class="badge badge-arts teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sports')) { %>
                                            <span class="badge badge-sports teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else { %>
                                            <span class="badge badge-secondary teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } %>
                                    </div>
                                <% } else { %>
                                    <span class="text-muted">-</span>
                                <% } %>
                            </span>
                            <div class="btn-group btn-group-sm ml-2">
                                <button class="btn btn-outline-primary edit-btn" data-toggle="modal" data-target="#editModal" 
                                        title="Edit lesson">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger delete-btn" title="Clear lesson">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </td>
                <% }); %>
            </tr>

            <!-- Lesson 6 (Slot 5) -->
            <tr data-slot="5">
                <td class="font-weight-bold">
                    <div>13:25 - 14:25</div>
                    <small class="text-muted">Lesson 6</small>
                </td>
                <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { %>
                    <% const teacher = data.timetable && data.timetable[day] && data.timetable[day][5]; %>
                    <td data-day="<%= day %>" class="slot-cell">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="subjects flex-grow-1">
                                <% if (teacher) { %>
                                    <div class="teacher-display">
                                        <% if (teacher.includes('Languages')) { %>
                                            <span class="badge badge-languages teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sciences')) { %>
                                            <span class="badge badge-sciences teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Arts')) { %>
                                            <span class="badge badge-arts teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else if (teacher.includes('Sports')) { %>
                                            <span class="badge badge-sports teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } else { %>
                                            <span class="badge badge-secondary teacher-badge">
                                                <%= teacher %>
                                            </span>
                                        <% } %>
                                    </div>
                                <% } else { %>
                                    <span class="text-muted">-</span>
                                <% } %>
                            </span>
                            <div class="btn-group btn-group-sm ml-2">
                                <button class="btn btn-outline-primary edit-btn" data-toggle="modal" data-target="#editModal" 
                                        title="Edit lesson">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger delete-btn" title="Clear lesson">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </td>
                <% }); %>
            </tr>

            <!-- Lunch Break (No Slot) -->
            <tr class="table-warning">
                <td class="font-weight-bold text-center">
                    <div>14:25 - 15:00</div>
                    <small class="text-muted">Lunch Break</small>
                </td>
                <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { %>
                    <td class="text-center text-muted">
                        <i class="fas fa-utensils"></i> Lunch
                    </td>
                <% }); %>
            </tr>
        </tbody>
    </table>
</div>

<!-- Add CSS for teacher badges -->
<style>
.teacher-display {
    line-height: 1.3;
    min-height: 45px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.teacher-badge {
    font-size: 0.85rem;
    padding: 5px 10px;
    display: inline-block;
    font-weight: 500;
}

/* Custom badge colors for different teachers */
.badge-languages {
    background-color: #007bff; /* Blue for Languages */
    color: white;
}
.badge-sciences {
    background-color: #28a745; /* Green for Sciences */
    color: white;
}
.badge-arts {
    background-color: #ffc107; /* Yellow for Arts */
    color: #212529;
}
.badge-sports {
    background-color: #dc3545; /* Red for Sports */
    color: white;
}

.badge-languages[class*="A"] {
    background-color: #1e88e5; /* Slightly different blue for Languages A */
}
.badge-languages[class*="B"] {
    background-color: #64b5f6; /* Lighter blue for Languages B */
}

.badge-sciences[class*="A"] {
    background-color: #43a047; /* Slightly different green for Sciences A */
}
.badge-sciences[class*="B"] {
    background-color: #81c784; /* Lighter green for Sciences B */
}

.slot-cell {
    min-height: 70px;
    vertical-align: middle !important;
}
</style>

<div class="mt-4 d-flex justify-content-between align-items-center flex-wrap">
    <div class="constraints-info mb-2">
        <small class="text-muted">
            <strong>Teacher Assignments:</strong> 
            Languages A (max 6h) • Languages B (max 6h) • Sciences A (max 6h) • Sciences B (max 6h) • Arts Teacher (5h) • Sports Teacher (5h)
        </small>
        <br>
        <small class="text-muted">
            <strong>Daily Limit:</strong> 6 hours per day • <strong>Colors:</strong> Languages (Blue) • Sciences (Green) • Arts (Yellow) • Sports (Red)
        </small>
    </div>
    <button id="save-timetable" class="btn btn-success btn-lg">
        <i class="fas fa-save"></i> Save Timetable
    </button>
</div>
<!-- Deleted Lessons History Panel -->
<div id="deleted-lessons-panel" class="mt-4">
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-history"></i> Recently Deleted Lessons
                <small class="text-muted">(Available to add back)</small>
            </h5>
        </div>
        <div class="card-body p-3">
            <div id="deleted-lessons-list" class="deleted-lessons-container">
                <% if (data.deletedLessons && data.deletedLessons.length > 0) { %>
                    <div class="row">
                        <% data.deletedLessons.forEach((lesson, index) => { %>
                            <% if (lesson.teacher) { %>
                                <div class="col-md-4 mb-2">
                                    <div class="deleted-lesson-item p-2 border rounded bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="badge 
                                                    <% if (lesson.teacher.includes('Languages')) { %>badge-languages<% } %>
                                                    <% if (lesson.teacher.includes('Sciences')) { %>badge-sciences<% } %>
                                                    <% if (lesson.teacher.includes('Arts')) { %>badge-arts<% } %>
                                                    <% if (lesson.teacher.includes('Sports')) { %>badge-sports<% } %>">
                                                    <%= lesson.teacher %>
                                                </span>
                                                <small class="text-muted ml-2">
                                                    <%= lesson.day %> • Lesson <%= parseInt(lesson.slot) + 1 %>
                                                </small>
                                            </div>
                                            <button class="btn btn-sm btn-outline-primary restore-btn" 
                                                    data-day="<%= lesson.day %>" 
                                                    data-slot="<%= lesson.slot %>"
                                                    data-teacher="<%= lesson.teacher %>"
                                                    title="Restore this lesson">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
                        <% }); %>
                    </div>
                <% } else { %>
                    <p class="text-muted mb-0 text-center">No recently deleted lessons. Delete a lesson to see it here.</p>
                <% } %>
            </div>
        </div>
    </div>
</div>

<style>
.deleted-lessons-container {
    max-height: 200px;
    overflow-y: auto;
}
.deleted-lesson-item {
    transition: all 0.2s;
}
.deleted-lesson-item:hover {
    background-color: #f8f9fa !important;
    transform: translateY(-2px);
}
.restore-btn {
    padding: 2px 8px;
    font-size: 0.8rem;
}
</style>

<script>
// Restore deleted lesson functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.restore-btn')) {
        const restoreBtn = e.target.closest('.restore-btn');
        const day = restoreBtn.dataset.day;
        const slot = parseInt(restoreBtn.dataset.slot);
        const teacher = restoreBtn.dataset.teacher;
        
        console.log('Restoring lesson:', day, slot, teacher);
        
        // Get current timetable
        const timetable = JSON.parse(JSON.stringify(currentTimetable));
        
        // Restore the teacher to the slot
        if (!timetable[day]) {
            timetable[day] = [];
        }
        timetable[day][slot] = teacher;
        
        // Save the timetable
        const saveButton = document.getElementById('save-timetable');
        const originalText = saveButton.innerHTML;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restoring...';
        saveButton.disabled = true;
        
        fetch('/save-timetable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ timetable: timetable })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Restore response:', data);
            const timetableContainer = document.getElementById('timetable-container');
            if (timetableContainer && data.timetableHtml) {
                timetableContainer.innerHTML = data.timetableHtml;
                currentTimetable = data.timetable;
            }
            if (data.message) {
                showMessage(data.message, 'success');
            }
            // Refresh the deleted lessons panel
            loadDeletedLessons();
        })
        .catch(error => {
            console.error('Error restoring lesson:', error);
            showMessage('❌ Error restoring lesson: ' + error.message, 'error');
        })
        .finally(() => {
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        });
    }
});

// Function to load deleted lessons
function loadDeletedLessons() {
    fetch('/get-deleted-lessons')
        .then(response => response.json())
        .then(data => {
            // This would ideally refresh the deleted lessons panel
            // For now, we'll just reload the timetable section
            showTimetableSection();
        })
        .catch(error => {
            console.error('Error loading deleted lessons:', error);
        });
}
</script>